#!/bin/bash
echo > report.txt
#make

function test_value() {
  #want="$1"
  input="$1"
  result_emu="$(echo $input | python nlpemu/nlp16a.py )"
  echo "emu : '$result_emu'"
  echo $input | fold -w4 > test_mem_dump.txt
  result_sv="$(iverilog -g 2012 -o system_tb.sv.out system_tb.sv && vvp system_tb.sv.out | grep "result=" | cut -d'=' -f2 )"
  echo "result : '$result_sv'"
  if [ $? -ne 0 ] ; then
    echo 'execution error'
    echo $?
    echo $result
    exit 1
  fi

  if [ $((0x$result_emu)) = $((0x$result_sv)) ]
  then
    echo -e "\033[32m[  OK  ]\033[m: $input -> '$result_sv'"
    echo "[  OK  ]: $input -> '$result_sv'" >> report.txt
  else
    echo -e "\033[31m[FAILED]\033[m: $input -> '$result_sv', want '$result_emu'"
    echo "[FAILED]: $input -> '$result_sv', want '$result_emu'" >> report.txt
  fi
}
test_value "901130AAFF00" #STORE
test_value "0A1513AA5500901530AAFF00" #ADD
test_value "001E30FF03FF001630555555D016C01590153000FF00" #PUSH POP
test_value "001610AA9016300003FF8015300003FF90153000FF00" #LOAD STORE
test_value "001e30ff03ff001610aa001710a5b01d100b0a1dd1030a156700c01d90153000ff00" #CALL RET JMP
test_value "001e30ff03ff001610aa001710a5b01d100b0a1dd108001530ffffff091f670000e51000c01d90153000ff00" #CMP sign
test_value "001e30ff03ff001610aa001710a5b01d100b0a1dd108001530ffffff091f670000c51000c01d90153000ff00" #CMP zero
test_value "001E30FF03FF0A15D1E59A15D1E2BA1DD1BF0A1DD1B7B01D1011C01DB01D1013C01D0016100A90153000FF000016104090153000FF0090153003FF030A1DD1A290153002FF02C01DD016D017D01800151000091F61000AEDD1061B155000141660001B166000091F71000AEDD1061B155000141770001B177000D015001870000015100000181000091F810F0AEDD10C061F71010AC5560020166000301770001B188000091DD110C017091F710114D55000091F71011BD55000C018C017C016C01DD017D01800151000091F61000AEDD1061B155000141660001B166000091F71000AEDD1061B155000141770001B177000D015001870002017700009EDD10400151000091F78000ADDD10E2015500030177000091F6700099DD10C1215510109166700091DD112C017091F710114D55000091F71011BD55000C018C017C01DD016D017091F71000ADDD1062016600018177000091DD10A00156000C017C016C01DD016D017091F71000ADDD1063016600018177000091DD10A00156000C017C016C01D90153000FF00C01D091DD102D0180018E000091EE1000015100AD01500151002D01500151003D015C017C01609156700D015C017C0160A156700D015C015001E8000C018C01D001E8000C018C01D0000" #int main(){return 10+(2-3);}
test_value "001E30FF03FF0A15D1DD9A15D1DABA1DD1BF0A1DD1B7B01D1011C01DB01D1013C01D0016100A90153000FF000016104090153000FF0090153003FF030A1DD1A290153002FF02C01DD016D017D01800151000091F61000AEDD1061B155000141660001B166000091F71000AEDD1061B155000141770001B177000D015001870000015100000181000091F810F0AEDD10C061F71010AC5560020166000301770001B188000091DD110C017091F710114D55000091F71011BD55000C018C017C016C01DD017D01800151000091F61000AEDD1061B155000141660001B166000091F71000AEDD1061B155000141770001B177000D015001870002017700009EDD10400151000091F78000ADDD10E2015500030177000091F6700099DD10C1215510109166700091DD112C017091F710114D55000091F71011BD55000C018C017C01DD016D017091F71000ADDD1062016600018177000091DD10A00156000C017C016C01DD016D017091F71000ADDD1063016600018177000091DD10A00156000C017C016C01D90153000FF00C01D091DD102D0180018E000091EE10000151002D01500151003D015C017C016B91DD1B3D015C015001E8000C018C01D001E8000C018C01D0000" #int main(){return 2*3;}